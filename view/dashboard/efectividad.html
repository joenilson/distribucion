<!--
Copyright (C) 2017 Joe Nilson <joenilson at gmail.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<script>
function cargarGraficoEfectividad(componente,tipo_grafico,datos, labels,options){
    /**
     * Hacemos la llamada AJAX, en la página origen del grafico se debe colocar
     * el valor de la variable url_graficos
     */
    var chartData = {
        labels: labels,
        datasets: [
          {
            label: "Venta",
            fillColor: "rgba(220,220,220,0.2)",
            strokeColor: "rgba(220,220,220,1)",
            pointColor: "rgba(220,220,220,1)",
            data: []
          }
        ]
    };
    
    $.each(datos, function(position, detalleFecha) {
        chartData.datasets[0].data.push(detalleFecha);
    });
    
    new Chart($(componente), {
        type: tipo_grafico,
        data: chartData,
        options: {
            height: 200,
        }
    });
}
</script>
<div role="tabpanel" class="tab-pane" id="efectividad" style="overflow-y:scroll; height: 600px;">
    {if="$fsc->procesado"}
    <div class="row">
        <div class="col-sm-8">
            <div class="panel panel-primary">
                <!-- Default panel contents -->
                <div class="panel-heading">
                    <h2 class="panel-title">
                        Reporte por Supervisor > Vendedor > Ruta
                    </h2>
                </div>
                {loop="$fsc->supervisores"}
                    <div class="panel-body">
                        <h3>Supervisor: {$value1->nombre} <small>{$fsc->clientes_rutas['mesa_vendedores'][$value1->codagente]} vendedores</small></h3>
                    </div>
                    {loop="$fsc->organizacion->get_asignados($fsc->empresa->id,$value1->codagente)"}
                    <ul class="list-group">
                        <li class="list-group-item">
                            <h4>Vendedor: {$value2->nombre} <small>{$fsc->clientes_rutas['total_rutas'][$value2->codagente]} Rutas</small></h4>
                            {if="$fsc->clientes_rutas['total_cantidad'][$value2->codagente]"}
                            <canvas height="200" id="vendedor{$value2->codagente}"></canvas>
                            <script>
                                cargarGraficoEfectividad('#vendedor{$value2->codagente}','line',{function="json_encode($fsc->graficos_efectividad_data['fecha'][$value2->codagente])"},{function="json_encode($fsc->graficos_fecha_labels)"});
                            </script>
                            {else}
                            <div class="well text-warning bg-warning">No hay datos para mostrar un gráfico</div>
                            {/if}
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th class="text-center">Ruta</th>
                                        <th class="text-center">Clientes</th>
                                        <th class="text-center">Atendidos</th>
                                        <th class="text-center">No Atendidos</th>
                                        <th class="text-center">% Efectividad</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-center">Importe</th>
                                        <th class="text-center">Oferta</th>
                                        <th class="text-center">Part Cantidad</th>
                                        <th class="text-center">Part Importe</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {loop="$fsc->rutas->all_rutasporagente($fsc->empresa->id, $value2->codalmacen, $value2->codagente)"}
                                    <tr>
                                        <td class="text-left">{$value3->ruta}</td>
                                        <td class="text-right">{$fsc->clientes_rutas['total'][$value3->ruta]}</td>
                                        <td class="text-right">{$fsc->clientes_rutas['atendidos'][$value3->ruta]}</td>
                                        <td class="text-right">{$fsc->clientes_rutas['no_atendidos'][$value3->ruta]}</td>
                                        <td class="text-center {$fsc->clientes_rutas['efectividad_color'][$value3->ruta]}">{$fsc->clientes_rutas['efectividad'][$value3->ruta]}%</td>
                                        <td class="text-right">{$fsc->clientes_rutas['cantidad'][$value3->ruta]}</td>
                                        <td class="text-right">{$fsc->show_numero($fsc->clientes_rutas['importe'][$value3->ruta])}</td>
                                        <td class="text-right">{$fsc->clientes_rutas['oferta'][$value3->ruta]}</td>
                                        <td class="text-right"></td>
                                        <td class="text-right"></td>
                                    </tr>
                                    {/loop}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th>Sumas</th>
                                        <th class="text-right">{$fsc->clientes_rutas['total_clientes'][$value2->codagente]}</th>
                                        <th class="text-right">{$fsc->clientes_rutas['total_atendidos'][$value2->codagente]}</th>
                                        <th class="text-right">{$fsc->clientes_rutas['total_no_atendidos'][$value2->codagente]}</th>
                                        <th class="text-right"></th>
                                        <th class="text-right">{$fsc->clientes_rutas['total_cantidad'][$value2->codagente]}</th>
                                        <th class="text-right">{$fsc->show_numero($fsc->clientes_rutas['total_importe'][$value2->codagente])}</th>
                                        <th class="text-right">{$fsc->clientes_rutas['total_oferta'][$value2->codagente]}</th>
                                        <th class="text-center"></th>
                                        <th class="text-center"></th>
                                    </tr>
                                    <tr>
                                        <th>Promedios</th>
                                        <th class="text-right">{$fsc->show_numero($fsc->clientes_rutas['total_clientes'][$value2->codagente]/$fsc->clientes_rutas['total_rutas'][$value2->codagente],0)}</th>
                                        <th class="text-right">{$fsc->show_numero($fsc->clientes_rutas['total_atendidos'][$value2->codagente]/$fsc->clientes_rutas['total_rutas'][$value2->codagente],0)}</th>
                                        <th class="text-right">{$fsc->show_numero($fsc->clientes_rutas['total_no_atendidos'][$value2->codagente]/$fsc->clientes_rutas['total_rutas'][$value2->codagente],0)}</th>
                                        <th class="text-center {$fsc->clientes_rutas['efectividad_vendedor_color'][$value2->codagente]}">{$fsc->clientes_rutas['efectividad_vendedor'][$value2->codagente]}%</th>
                                        <th class="text-center"></th>
                                        <th class="text-center"></th>
                                        <th class="text-center"></th>
                                        <th class="text-center"></th>
                                        <th class="text-center"></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </li>                        
                    </ul>
                    {/loop}
                {/loop}
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="text-center">SUPERVISOR</th>
                    <th class="text-center">VENDEDOR</th>
                    <th class="text-center">RUTA</th>
                    <th class="text-center">CLIENTES</th>
                    <th class="text-center">ATENTIDOS</th>
                    <th class="text-center">NO ATENDIDOS</th>
                    <th class="text-center">% EFECTIVIDAD</th>
                </tr>
            </thead>
            <tbody>
                {loop="$fsc->supervisores"}
                    <!-- {$inicio=0} !-->
                    {loop="$fsc->organizacion->get_asignados($fsc->empresa->id,$value1->codagente)"}
                        {loop="$fsc->rutas->all_rutasporagente($fsc->empresa->id, $value2->codalmacen, $value2->codagente)"}
                        <tr>
                            {if="$inicio==0"}
                            <td class="text-left" rowspan="{$fsc->clientes_rutas['mesa_rutas'][$value1->codagente]+$fsc->clientes_rutas['mesa_vendedores'][$value1->codagente]}">{$value1->nombre}</td>
                            {/if}
                            {if="$counter==0"}
                            <td class="text-left" rowspan="{$fsc->clientes_rutas['total_rutas'][$value2->codagente]}">{$value2->nombre}</td>
                            {/if}
                            <td class="text-left">{$value3->ruta}</td>
                            <td class="text-right">{$fsc->clientes_rutas['total'][$value3->ruta]}</td>
                            <td class="text-right">{$fsc->clientes_rutas['atendidos'][$value3->ruta]}</td>
                            <td class="text-right">{$fsc->clientes_rutas['no_atendidos'][$value3->ruta]}</td>
                            <td class="text-center {$fsc->clientes_rutas['efectividad_color'][$value3->ruta]}">{$fsc->clientes_rutas['efectividad'][$value3->ruta]}%</td>
                        </tr>                       
                        <!-- {$inicio++} !-->
                        {/loop}
                        <tr>
                            <td colspan="2" class="text-right info"><b>Total de {$value2->nombre}</b></td>
                            <td class="text-right info"><b>{$fsc->clientes_rutas['total_clientes'][$value2->codagente]}</b></td>
                            <td class="text-right info"><b>{$fsc->clientes_rutas['total_atendidos'][$value2->codagente]}</b></td>
                            <td class="text-right info"><b>{$fsc->clientes_rutas['total_no_atendidos'][$value2->codagente]}</b></td>
                            <td class="text-center {$fsc->clientes_rutas['efectividad_vendedor_color'][$value2->codagente]}"><b>{$fsc->clientes_rutas['efectividad_vendedor'][$value2->codagente]}%</b></td>
                        </tr>
                    {/loop}                  
                    <tr>
                        <td colspan="3" class="text-left info"><b>Total de {$value1->nombre}</b></td>
                        <td class="text-right info"><b>{$fsc->clientes_rutas['mesa_clientes'][$value1->codagente]}</b></td>
                        <td class="text-right info"><b>{$fsc->clientes_rutas['mesa_atendidos'][$value1->codagente]}</b></td>
                        <td class="text-right info"><b>{$fsc->clientes_rutas['mesa_no_atendidos'][$value1->codagente]}</b></td>
                        <td class="text-center {$fsc->clientes_rutas['efectividad_mesa_color'][$value1->codagente]}"><b>{$fsc->clientes_rutas['mesa_efectividad'][$value1->codagente]}%</b></td>
                    </tr>
                {/loop}
            </tbody>
        </table>
    </div>
    {/if}
</div>